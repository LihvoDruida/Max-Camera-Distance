name: Continuous Integration

on:
  push:
    tags:
      - "*"
      - "!**-alpha**"
      - "!**-beta**"

permissions:
  contents: write # Потрібно для створення релізів на GitHub

jobs:
  release:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Генеруємо changelog тільки для поточного тега
      - name: Generate CHANGELOG.md
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          # --latest: бере зміни тільки для останнього тега
          # --strip header: прибирає заголовок, щоб не дублювати його в описі релізу
          args: --latest --strip header --output CHANGELOG.md

      # Перевіряємо, чи файл створився (для дебагу)
      - name: Verify Changelog
        run: cat CHANGELOG.md

      # Packager сам робить заміну версії в .toc, архівує та завантажує
      - name: Create and Upload Package
        uses: BigWigsMods/packager@v2
        with:
          # -c вказує використати наш згенерований changelog замість стандартного
          args: -c CHANGELOG.md
        env:
          CF_API_KEY: ${{ secrets.CF_API_KEY }}
          GITHUB_OAUTH: ${{ secrets.GITHUB_TOKEN }} # Для створення релізу на GitHub
          # WAGO_API_TOKEN: ${{ secrets.WAGO_API_TOKEN }} # Якщо ви використовуєте Wago.io

      - name: Add Summary
        run: echo "## ✅ Release ${{ github.ref_name }} Published" >> $GITHUB_STEP_SUMMARY

      - name: Notify Discord on Failure
        if: failure()
        uses: nebularg/actions-discord-webhook@v1
        with:
          webhook_url: ${{ secrets.WEBHOOK_URL }}
          status: ${{ job.status }}